/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JPanel.java to edit this template
 */
package admin;

/**
 *
 * @author Acer Aspire Lite 15
 */
import config.Koneksi;
import java.awt.BorderLayout;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Date;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTable;
import javax.swing.table.DefaultTableModel;

public class LAP_TRANSAKSI_MINNGUAN extends javax.swing.JPanel {

    /**
     * Creates new form LAP_TRANSAKSI_HARIAN
     */
    private DefaultTableModel tableModel;

    public LAP_TRANSAKSI_MINNGUAN() {
        initComponents();
        initPanel();
    }

    private void initPanel() {
        tableModel = (DefaultTableModel) tabel_transaksi_mingguan.getModel();

        // Atur tanggal default saat panel dibuka
        Calendar cal = Calendar.getInstance();
        filter_DateChooser2.setDate(cal.getTime()); // Tanggal akhir = hari ini
        cal.add(Calendar.DAY_OF_MONTH, -7); // Mundur 7 hari
        filter_DateChooser1.setDate(cal.getTime()); // Tanggal awal = 7 hari yang lalu

        // Langsung muat data untuk rentang default
        loadTransactionData(filter_DateChooser1.getDate(), filter_DateChooser2.getDate(), null);
    }

    private void loadTransactionData(Date startDate, Date endDate, String searchTerm) {
        tableModel.setRowCount(0);

        String sql = "SELECT id_transaksi, tanggal, kasir, total_akhir, bayar, kembalian, metode_pembayaran FROM transaksi";

        try (Connection conn = Koneksi.getConnection()) {
            PreparedStatement ps;

            if (searchTerm != null && !searchTerm.isEmpty()) {
                // Mode Pencarian
                sql += " WHERE id_transaksi ILIKE ? OR kasir ILIKE ?";
                ps = conn.prepareStatement(sql);
                String pattern = "%" + searchTerm + "%";
                ps.setString(1, pattern);
                ps.setString(2, pattern);
            } else {
                // Mode Filter Rentang Tanggal
                if (startDate == null || endDate == null) {
                    JOptionPane.showMessageDialog(this, "Silakan pilih rentang tanggal!", "Peringatan",
                            JOptionPane.WARNING_MESSAGE);
                    return;
                }
                sql += " WHERE tanggal::date BETWEEN ? AND ? ORDER BY tanggal DESC";
                ps = conn.prepareStatement(sql);
                ps.setDate(1, new java.sql.Date(startDate.getTime()));
                ps.setDate(2, new java.sql.Date(endDate.getTime()));
            }

            ResultSet rs = ps.executeQuery();
            int no = 1;
            SimpleDateFormat dateFormat = new SimpleDateFormat("dd-MM-yyyy HH:mm");
            while (rs.next()) {
                tableModel.addRow(new Object[] {
                        no++,
                        rs.getString("id_transaksi"),
                        dateFormat.format(rs.getTimestamp("tanggal")),
                        rs.getString("kasir"),
                        rs.getLong("total_akhir"),
                        rs.getLong("bayar"),
                        rs.getLong("kembalian"),
                        rs.getString("metode_pembayaran")
                });
            }
            rs.close();
            ps.close();
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, "Gagal memuat data transaksi: " + e.getMessage());
            e.printStackTrace();
        }
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated
    // Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        tf_pencarian = new javax.swing.JTextField();
        jScrollPane1 = new javax.swing.JScrollPane();
        tabel_transaksi_mingguan = new javax.swing.JTable();
        btn_detail = new javax.swing.JButton();
        btn_cari = new javax.swing.JButton();
        jLabel1 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        btn_refresh = new javax.swing.JButton();
        filter_DateChooser1 = new com.toedter.calendar.JDateChooser();
        filter_DateChooser2 = new com.toedter.calendar.JDateChooser();

        setBackground(new java.awt.Color(255, 255, 255));
        setMinimumSize(new java.awt.Dimension(1630, 750));
        setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        tf_pencarian.setFont(new java.awt.Font("Segoe UI", 0, 18)); // NOI18N
        add(tf_pencarian, new org.netbeans.lib.awtextra.AbsoluteConstraints(20, 40, 500, 50));

        tabel_transaksi_mingguan.setFont(new java.awt.Font("Segoe UI", 0, 14)); // NOI18N
        tabel_transaksi_mingguan.setModel(new javax.swing.table.DefaultTableModel(
                new Object[][] {
                        { null, null, null, null, null, null, null, null },
                        { null, null, null, null, null, null, null, null },
                        { null, null, null, null, null, null, null, null },
                        { null, null, null, null, null, null, null, null }
                },
                new String[] {
                        "NO.", "ID TRANSAKSI", "TANGGAL", "KASIR", "TOTAL", "BAYAR", "KEMBALIAN", "METODE PEMBAYARAN"
                }) {
            Class[] types = new Class[] {
                    java.lang.String.class, java.lang.String.class, java.lang.String.class, java.lang.String.class,
                    java.lang.String.class, java.lang.String.class, java.lang.String.class, java.lang.String.class
            };
            boolean[] canEdit = new boolean[] {
                    false, false, false, false, false, false, true, false
            };

            public Class getColumnClass(int columnIndex) {
                return types[columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit[columnIndex];
            }
        });
        tabel_transaksi_mingguan.setRowHeight(30);
        jScrollPane1.setViewportView(tabel_transaksi_mingguan);

        add(jScrollPane1, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 130, 1610, 610));

        btn_detail.setFont(new java.awt.Font("Segoe UI", 1, 18)); // NOI18N
        btn_detail.setText("DETAIL");
        btn_detail.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btn_detailActionPerformed(evt);
            }
        });
        add(btn_detail, new org.netbeans.lib.awtextra.AbsoluteConstraints(680, 40, 150, 50));

        btn_cari.setFont(new java.awt.Font("Segoe UI", 1, 18)); // NOI18N
        btn_cari.setText("CARI");
        btn_cari.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btn_cariActionPerformed(evt);
            }
        });
        add(btn_cari, new org.netbeans.lib.awtextra.AbsoluteConstraints(520, 40, 150, 50));

        jLabel1.setFont(new java.awt.Font("Segoe UI", 1, 18)); // NOI18N
        jLabel1.setText("TANGGAL AWAL :");
        add(jLabel1, new org.netbeans.lib.awtextra.AbsoluteConstraints(1037, 20, 200, 40));

        jLabel2.setFont(new java.awt.Font("Segoe UI", 1, 18)); // NOI18N
        jLabel2.setText("SAMPAI TANGGAL :");
        add(jLabel2, new org.netbeans.lib.awtextra.AbsoluteConstraints(1040, 70, 200, 40));

        btn_refresh.setFont(new java.awt.Font("Segoe UI", 1, 18)); // NOI18N
        btn_refresh.setText("REFRESH");
        btn_refresh.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btn_refreshActionPerformed(evt);
            }
        });
        add(btn_refresh, new org.netbeans.lib.awtextra.AbsoluteConstraints(840, 40, 150, 50));
        add(filter_DateChooser1, new org.netbeans.lib.awtextra.AbsoluteConstraints(1240, 20, 270, 40));
        add(filter_DateChooser2, new org.netbeans.lib.awtextra.AbsoluteConstraints(1240, 70, 270, 40));
    }// </editor-fold>//GEN-END:initComponents

    private void btn_cariActionPerformed(java.awt.event.ActionEvent evt) {// GEN-FIRST:event_btn_cariActionPerformed
        // TODO add your handling code here:
        loadTransactionData(null, null, tf_pencarian.getText());
    }// GEN-LAST:event_btn_cariActionPerformed

    private void btn_refreshActionPerformed(java.awt.event.ActionEvent evt) {// GEN-FIRST:event_btn_refreshActionPerformed
        // TODO add your handling code here:
        tf_pencarian.setText("");
        loadTransactionData(filter_DateChooser1.getDate(), filter_DateChooser2.getDate(), null);
    }// GEN-LAST:event_btn_refreshActionPerformed

    private void btn_detailActionPerformed(java.awt.event.ActionEvent evt) {// GEN-FIRST:event_btn_detailActionPerformed
        // TODO add your handling code here:
        int selectedRow = tabel_transaksi_mingguan.getSelectedRow();

        if (selectedRow == -1) {
            JOptionPane.showMessageDialog(this, "Silakan pilih transaksi yang ingin dilihat detailnya!", "Peringatan",
                    JOptionPane.WARNING_MESSAGE);
            return;
        }

        // Ambil ID Transaksi dari kolom kedua (indeks 1)
        String transactionId = tableModel.getValueAt(selectedRow, 1).toString();

        // 1. Buat panel utama untuk pop-up
        JPanel detailPopupPanel = new JPanel(new BorderLayout(10, 10));

        // 2. Buat panel atas untuk info utama transaksi (ID, Tanggal, Kasir, Total,
        // dll.)
        JPanel topPanel = new JPanel(new java.awt.GridLayout(0, 4, 10, 5));

        // 3. Buat tabel untuk menampilkan daftar barang yang dibeli
        JTable itemsTable = new JTable();
        DefaultTableModel itemsTableModel = new DefaultTableModel(
                new Object[] { "ID Barang", "Nama Barang", "Harga", "Jumlah", "Total" }, 0);
        itemsTable.setModel(itemsTableModel);
        itemsTable.setFont(new java.awt.Font("Segoe UI", 0, 14));
        itemsTable.setRowHeight(25);

        // 4. Ambil semua data dari database
        try (Connection conn = Koneksi.getConnection()) {
            // Query untuk data transaksi utama dari tabel 'transaksi'
            String sqlTransaksi = "SELECT * FROM transaksi WHERE id_transaksi = ?";
            try (PreparedStatement ps = conn.prepareStatement(sqlTransaksi)) {
                ps.setString(1, transactionId);
                ResultSet rs = ps.executeQuery();
                if (rs.next()) {
                    // Tambahkan label dan data ke panel atas
                    topPanel.add(new JLabel("ID Transaksi:"));
                    topPanel.add(new JLabel(rs.getString("id_transaksi")));
                    topPanel.add(new JLabel("Total Akhir:"));
                    topPanel.add(new JLabel("Rp " + rs.getLong("total_akhir")));

                    topPanel.add(new JLabel("Tanggal:"));
                    topPanel.add(
                            new JLabel(new SimpleDateFormat("dd-MM-yyyy HH:mm").format(rs.getTimestamp("tanggal"))));
                    topPanel.add(new JLabel("Bayar:"));
                    topPanel.add(new JLabel("Rp " + rs.getLong("bayar")));

                    topPanel.add(new JLabel("Kasir:"));
                    topPanel.add(new JLabel(rs.getString("kasir")));
                    topPanel.add(new JLabel("Kembalian:"));
                    topPanel.add(new JLabel("Rp " + rs.getLong("kembalian")));
                }
            }

            // Query untuk detail barang dari tabel 'detail_transaksi'
            String sqlDetail = "SELECT * FROM detail_transaksi WHERE id_transaksi = ?";
            try (PreparedStatement ps = conn.prepareStatement(sqlDetail)) {
                ps.setString(1, transactionId);
                ResultSet rs = ps.executeQuery();
                while (rs.next()) {
                    // Tambahkan setiap barang ke tabel 'itemsTable'
                    itemsTableModel.addRow(new Object[] {
                            rs.getString("id_barang"),
                            rs.getString("nama_barang"),
                            rs.getLong("harga_jual"),
                            rs.getInt("jumlah_beli"),
                            rs.getLong("total")
                    });
                }
            }
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, "Gagal mengambil detail transaksi: " + e.getMessage());
            e.printStackTrace();
            return;
        }

        // 5. Gabungkan panel atas dan tabel ke dalam panel utama pop-up
        detailPopupPanel.add(topPanel, BorderLayout.NORTH);
        detailPopupPanel.add(new JScrollPane(itemsTable), BorderLayout.CENTER);

        // 6. Tampilkan panel pop-up menggunakan JOptionPane
        JOptionPane.showMessageDialog(this, detailPopupPanel, "Detail Transaksi: " + transactionId,
                JOptionPane.PLAIN_MESSAGE);
    }// GEN-LAST:event_btn_detailActionPerformed

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btn_cari;
    private javax.swing.JButton btn_detail;
    private javax.swing.JButton btn_refresh;
    private com.toedter.calendar.JDateChooser filter_DateChooser1;
    private com.toedter.calendar.JDateChooser filter_DateChooser2;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JTable tabel_transaksi_mingguan;
    private javax.swing.JTextField tf_pencarian;
    // End of variables declaration//GEN-END:variables
}
